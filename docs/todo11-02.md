承知いたしました。
`alice_chat_manager.py` をAPIクライアント（`chat.py`の`/chat/gemini`エンドポイントを利用）に移行するための実装TODOリストを、主要なタスクと方針に絞ってまとめます。

-----

### `alice_chat_manager.py` API移行 実装TODOリスト

**全体方針:**
`AliceChatManager` の責務を「プロンプト生成＆SDK呼び出し」から「**APIクライアント**」に全面的に変更する。
プロンプト構築、RAG（Compass API呼び出し）、LLM呼び出しのロジックはすべてサーバー側（`/chat/gemini`）に委譲する。

-----

### 1\. `config.py` の更新

  - [ ] **APIエンドポイントの追加:**
    `config.py` に、`chat.py` が動作するAPIサーバーのURLを設定する変数を追加する。

    ```python
    # 例: config/config.py
    CHAT_API_BASE_URL = os.environ.get('CHAT_API_BASE_URL', 'http://localhost:8000')
    ```

-----

### 2\. `AliceChatManager` の `__init__` 修正

  - [ ] **インポートの整理:**

      - `google.genai`, `openai`, `PIL.Image` を**削除**。
      - `requests` を**追加**。（`base64`, `mimetypes` は画像機能コミットオフのため、コメントアウトまたは将来用として残す）

  - [ ] **プロパティの変更:**

      - APIクライアント（`self.client`）やプロンプト関連（`self.system_instruction`, `self.long_term_memory`）のプロパティを**削除**。
      - APIエンドポイントと認証キーのプロパティを**追加**。

    <!-- end list -->

    ```python
    # 変更前:
    # self.client = None
    # self.api_provider = ...
    # self._init_client()
    # self._load_system_instruction()

    # 変更後:
    self.api_base_url = getattr(config, 'CHAT_API_BASE_URL', 'http://localhost:8000')
    self.api_endpoint = f"{self.api_base_url.rstrip('/')}/chat/gemini"
    self.api_key = getattr(config, 'COMPASS_API_KEY', None) # API認証用
    ```

-----

### 3\. 不要メソッドの削除

  - [ ] **サーバー側ロジックの削除:**
    以下のメソッドは、責務がAPIサーバー側に移るため、`AliceChatManager` クラスから**削除**する。
      - `_init_client()`
      - `_load_system_instruction()`
      - `_load_long_term_memory()`
      - `_get_past_conversations_from_compass_api()`
      - `_load_today_chat_log()`
      - `_prepare_contents()`
      - `_send_message_gemini()`
      - `_send_message_openai()`

-----

### 4\. APIリクエスト用ヘルパーメソッドの新規作成

  - [ ] **`_convert_to_chat_messages(self)`:**

      - `app_state` から会話履歴を取得し、`chat.py` が要求する `ChatMessage[]` のJSON形式（`List[Dict[str, str]]`）に変換する。
      - **画像対応（コミットオフ）:** メソッド内で `msg['metadata']['image_path']` をチェックするロジックは残す。
      - ただし、APIが未対応のため、base64エンコードやリクエストへの追加は行わず、`print` で警告を出すか、将来用の実装をコメントとして残す。

    <!-- end list -->

    ```python
    def _convert_to_chat_messages(self) -> List[Dict[str, Any]]:
        history = app_state.get_conversation_messages()
        messages = []
        for msg in history:
            # === [IMAGE COMMIT OFF BLOCK] ===
            if msg.get('metadata') and msg['metadata'].get('image_path'):
                print(f"DEBUG: Image path found, but API does not support sending. Ignoring.")
                # (ここに将来の画像エンコードロジックをコメントで残す)
            # === [END IMAGE COMMIT OFF BLOCK] ===
            
            messages.append({
                "role": msg['role'],
                "content": msg['content'] # テキストのみ送信
            })
        return messages
    ```

  - [ ] **`_build_chat_config(self)`:**

      - `self.config`（ANC側の設定）を読み取り、`chat.py` が要求する `ChatGeminiConfig` のJSON形式に**マッピング**する。
      - `ALICE_CHAT_CONFIG` の `temperature` 等を `{"gemini_params": ...}` にマッピングする。
      - `COMPASS_API_CONFIG` の `endpoint` や `limit` 等を `{"memory_search_config": ...}` にマッピングする。

  - [ ] **`_call_chat_api(self, messages, config)`:**

      - `requests.post` を使って、`self.api_endpoint` にリクエストを送信する。
      - `headers` に `Authorization` ( `self.api_key` ) を設定する。
      - `request_data = {"messages": messages, "config": config}` を `json` 引数で渡す。
      - `response.raise_for_status()` でエラーハンドリングを行い、`response.json()` を返す。

-----

### 5\. `send_message` メソッドの全面改修

  - [ ] **処理フローの変更:**
    プロンプト生成ロジックを削除し、API呼び出しフローに置き換える。

    ```python
    def send_message(self, user_message: str, image_path: Optional[str] = None) -> str:
        # (画像が指定された場合の警告ロジック - COMMIT OFF)
        if image_path:
            print(f"WARNING: API移行に伴い画像送信は一時的に無効化されています。")
            # メッセージは続行する

        try:
            # 1. AppStateにユーザーメッセージ追加 (画像メタデータも含む)
            app_state.add_conversation_message(
                'user', user_message.strip(),
                metadata={'image_path': image_path} if image_path else None
            )

            # 2. APIリクエスト構築
            messages = self._convert_to_chat_messages() # 画像はここで除外される
            config = self._build_chat_config()
            request_data = {"messages": messages, "config": config}

            # 3. API呼び出し
            api_response = self._call_chat_api(messages, config)
            response_text = api_response['response']['content']

            # 4. AppStateにモデルレスポンス追加
            app_state.add_conversation_message('model', response_text)

            # 5. ローカルログ保存 (変更不要)
            self._save_to_chat_log(user_message.strip(), response_text)
            self._log_api_dialog(request_data, api_response) # ログメソッドは要修正

            return response_text

        except requests.HTTPError as e:
            # APIからの詳細なエラーを返す
            return f"APIエラー ({e.response.status_code}): {e.response.json().get('error', {}).get('message', '詳細不明')}"
        except requests.Timeout:
            return "エラー: APIがタイムアウトしました。"
        except Exception as e:
            return f"エラー: {str(e)}"
    ```

-----

### 6\. 既存メソッドの微修正・維持

  - [ ] **`_log_dialog` の修正:**

      - `_log_api_dialog` にリネームし、SDKの応答ではなく、`request_data`（一部）と `api_response`（JSON）をログするように変更する。

  - [ ] **維持するメソッド:**

      - 以下のメソッドはローカルの `app_state` やファイルログを管理しており、API移行後もそのまま（または軽微な修正で）利用可能。
      - `_save_to_chat_log()`
      - `_trim_history()`
      - `get_history()`
      - `clear_history()`
      - `get_conversation_summary()`
      - `export_conversation()`

  - [ ] **`is_available()` の修正:**

      - SDKキーのチェックから、`CHAT_API_BASE_URL` が設定されているかのチェックに変更する。