# Bug Fix Plan: Stop Sending Historical Images to API

**Date:** 2025-11-06
**Version:** v3.3.0
**Priority:** High
**Type:** Bug Fix

---

## Problem Summary

Currently, **all historical images** in the conversation are being re-encoded and sent with every API call. This causes:
- Exponential growth in request size
- Unnecessary API costs
- Performance degradation
- Wasted bandwidth

### Example Scenario
1. User sends message with Image A → API receives Image A ✓
2. User sends text message → API receives Image A again ❌
3. User sends message with Image B → API receives Image A + Image B ❌
4. User sends text message → API receives Image A + Image B again ❌

**Result:** By the 10th message in a conversation with 3 images, we've sent those 3 images ~30 times instead of 3 times!

---

## Root Cause Analysis

### Location
**File:** `app/alice_chat_manager.py`, Lines 131-179
**Method:** `_convert_to_chat_messages()`

### The Bug Code
```python
def _convert_to_chat_messages(self) -> List[Dict[str, Any]]:
    """Convert conversation history to ChatMessage format for API."""
    history = app_state.get_conversation_messages()  # Gets ALL messages
    messages = []

    for msg in history:  # ❌ Loops through EVERY message
        # Check if message has image
        if msg.get('metadata') and msg['metadata'].get('image_path'):
            image_path = msg['metadata']['image_path']

            # ❌ BUG: This reads and encodes the image EVERY time!
            with open(image_path, 'rb') as f:
                image_data = base64.b64encode(f.read()).decode('utf-8')

            mime_type, _ = mimetypes.guess_type(image_path)

            messages.append({
                "role": msg['role'],
                "content": msg['content'],
                "images": [{
                    "mime_type": mime_type,
                    "data": image_data  # ❌ Full image data sent!
                }]
            })
```

### Why This Happens
1. `send_message()` calls `_convert_to_chat_messages()` on every API request (Line 271)
2. `_convert_to_chat_messages()` processes the **entire conversation history**
3. For **every** message with an image:
   - Opens the image file from disk
   - Reads the entire file into memory
   - Base64 encodes it (~1.33x file size)
   - Includes it in the API request
4. No distinction between "new message" vs "already processed message"

---

## Solution Design

### Core Principle
**Only include image data for the LATEST user message** that hasn't been sent to the API yet. Historical messages should exclude image data since the API already processed them.

### Implementation Approach

#### Option 1: Track Last Message Index (Chosen)
- Modify `_convert_to_chat_messages()` to accept the index of the new message
- Only encode image for that specific message
- Simple and efficient

#### Option 2: Add `image_sent` Flag to Metadata
- Track which images have been sent in message metadata
- More robust but requires state changes
- May be implemented later if needed

---

## Implementation Steps

### 1. Modify `_convert_to_chat_messages()` Method

**File:** `app/alice_chat_manager.py`, Lines 122-180

**Changes:**
```python
def _convert_to_chat_messages(self, new_message_index: Optional[int] = None) -> List[Dict[str, Any]]:
    """
    Convert conversation history to ChatMessage format for API.

    Args:
        new_message_index: Index of the new message (only this message's image will be included)
                          If None, no images will be included (for backward compatibility)
    """
    history = app_state.get_conversation_messages()
    messages = []

    for idx, msg in enumerate(history):
        # Only include image data for the NEW message
        should_include_image = (
            new_message_index is not None and
            idx == new_message_index and
            msg.get('metadata') and
            msg['metadata'].get('image_path')
        )

        if should_include_image:
            # [Keep existing image encoding logic]
            ...
        else:
            # Text-only message (even if it originally had an image)
            messages.append({
                "role": msg['role'],
                "content": msg['content']
            })

    return messages
```

**Key Changes:**
- Add `new_message_index` parameter
- Only encode image when `idx == new_message_index`
- Historical messages become text-only

---

### 2. Update `send_message()` Method

**File:** `app/alice_chat_manager.py`, Lines 246-307

**Changes:**
```python
def send_message(self, user_message: str, image_path: Optional[str] = None) -> Optional[str]:
    """Send a message with optional image to the chat API."""

    # Add user message to conversation
    app_state.add_conversation_message(
        'user',
        user_message.strip(),
        metadata={'image_path': image_path} if image_path else None
    )

    # Get the index of the message we just added
    history = app_state.get_conversation_messages()
    new_message_index = len(history) - 1  # Last message is the new one

    # Convert to API format - ONLY include new message's image
    messages = self._convert_to_chat_messages(new_message_index)

    # [Rest of the method remains the same]
    ...
```

**Key Changes:**
- Calculate `new_message_index` after adding message
- Pass it to `_convert_to_chat_messages()`
- Only the latest message's image is encoded

---

### 3. Optional: Add Image Sent Tracking (Future Enhancement)

**File:** `app/state_manager.py`

**Potential Addition:**
```python
def mark_message_image_sent(self, conversation_id: str, message_index: int):
    """Mark that a message's image has been sent to the API."""
    with self._lock:
        if conversation_id in self._conversations:
            messages = self._conversations[conversation_id].get('messages', [])
            if 0 <= message_index < len(messages):
                if 'metadata' not in messages[message_index]:
                    messages[message_index]['metadata'] = {}
                messages[message_index]['metadata']['image_sent'] = True
                self._save_conversations()
```

**Not implementing in initial fix** - can be added later for extra safety.

---

## Expected Behavior After Fix

### Test Scenario 1: Single Image
1. ✅ User sends message with Image A
   - API receives: Text + Image A
2. ✅ User sends text message
   - API receives: Text only (no images)
3. ✅ User sends text message
   - API receives: Text only (no images)

### Test Scenario 2: Multiple Images
1. ✅ User sends message with Image A
   - API receives: Text + Image A
2. ✅ User sends text message
   - API receives: Text only
3. ✅ User sends message with Image B
   - API receives: Text + Image B (NOT Image A!)
4. ✅ User sends text message
   - API receives: Text only

### Test Scenario 3: Conversation Reload
1. ✅ User sends message with Image A
2. ✅ App restarts, conversation loaded from `conversation_state.json`
3. ✅ User sends text message
   - API receives: Text only (Image A not re-sent)

---

## Files to Modify

### Primary Changes
- ✅ `app/alice_chat_manager.py` (Lines 122-180, 246-307)

### Documentation Updates
- ✅ `docs/plan/25-11-06.md` (this file)
- ✅ `CHANGELOG.md` (add bug fix entry)

### Testing
- ✅ Manual testing with image messages
- ✅ Check API request sizes in `logs/dialogs/`
- ⚠️ No automated tests yet (plugin system uses Ollama, not Gemini/OpenAI)

---

## Performance Impact

### Before Fix
- **10 messages with 3 images:** ~30 image encodings, ~40MB API request size
- **API cost:** 30x base cost for images
- **Memory usage:** Spikes on every API call
- **Latency:** Increases with conversation length

### After Fix
- **10 messages with 3 images:** 3 image encodings, ~4MB API request size
- **API cost:** 1x base cost for images ✓
- **Memory usage:** Stable ✓
- **Latency:** Constant regardless of history ✓

### Estimated Savings
- **90% reduction in image data sent**
- **10x reduction in API costs for image-heavy conversations**
- **Faster API response times**

---

## Risk Assessment

### Low Risk
- ✅ Change is localized to `alice_chat_manager.py`
- ✅ Does not affect state persistence
- ✅ Does not affect UI
- ✅ Backward compatible (optional parameter)

### Potential Issues
1. **API Context Loss:** Will the API "remember" images from earlier messages?
   - **Answer:** Yes, because the conversation history text is still sent. Most APIs maintain context from the full message history.
   - **Gemini:** Supports multi-turn conversations with image context
   - **OpenAI:** GPT-4 Vision maintains context across turns

2. **Image References in Text:** If user says "What color was that?" referring to an earlier image
   - **Answer:** API should maintain context from its previous responses about that image
   - **Mitigation:** If issues arise, we can implement smart image re-sending based on context

---

## Testing Plan

### Manual Testing Steps
1. **Test 1: Single image conversation**
   ```
   User: [sends "Analyze this" with cat.png]
   → Check logs/dialogs/*.json for image_count: 1

   User: "What else can you tell me?"
   → Check logs/dialogs/*.json for image_count: 0 ✓
   ```

2. **Test 2: Multiple images**
   ```
   User: [sends "First image" with image1.png]
   → image_count: 1

   User: [sends "Second image" with image2.png]
   → image_count: 1 (NOT 2!) ✓
   ```

3. **Test 3: API request size**
   ```
   Before fix: Check dialog log file size after 5 messages with 2 images
   After fix: Should be ~60% smaller ✓
   ```

4. **Test 4: API response quality**
   ```
   User: [sends image of cat]
   Alice: "I see a cat..."

   User: "What color was it?"
   Alice: Should correctly reference the cat from context ✓
   ```

### Log Verification
- Check `logs/dialogs/dialog-*.json` files
- Verify `image_count` is correct
- Verify `gemini_request_token_count` decreases on follow-up messages

---

## Implementation Checklist

- [ ] Back up current `alice_chat_manager.py`
- [ ] Modify `_convert_to_chat_messages()` method
- [ ] Update `send_message()` method
- [ ] Test with single image conversation
- [ ] Test with multiple images
- [ ] Test context retention
- [ ] Check API request logs
- [ ] Update CHANGELOG.md
- [ ] Commit changes
- [ ] Monitor for issues

---

## Rollback Plan

If issues arise:
1. Revert `alice_chat_manager.py` to previous version
2. Restart application
3. Investigate API behavior with conversation history
4. Consider implementing `image_sent` flag approach instead

**Git Rollback Command:**
```bash
git checkout HEAD -- app/alice_chat_manager.py
```

---

## Future Enhancements

### 1. Smart Image Re-sending
- Detect when user references past images
- Re-send relevant images only when needed
- Use NLP to identify image references

### 2. Image Context Tracking
- Track which images the API has processed
- Add `image_sent` flag to metadata
- Persist in `conversation_state.json`

### 3. Image Compression
- Compress images before base64 encoding
- Reduce API costs further
- Configurable quality settings

### 4. Image Caching
- Cache base64-encoded images in memory
- Avoid re-reading from disk if needed again
- Clear cache on conversation switch

---

## Related Issues

- **Performance:** Reduces API latency for long conversations
- **Cost:** Dramatically reduces API costs for Gemini/OpenAI usage
- **UX:** Faster response times
- **Architecture:** Better separation between "new" and "historical" data

---

## References

- **CLAUDE.md:** Architecture principles, state management
- **alice_chat_manager.py:** Current implementation
- **state_manager.py:** Conversation persistence
- **API Documentation:**
  - Gemini: Multi-turn conversations with images
  - OpenAI: GPT-4 Vision context handling

---

**Status:** ✅ Plan Approved
**Next Step:** Implementation
**Estimated Time:** 30 minutes
**Estimated Impact:** High (performance + cost savings)
