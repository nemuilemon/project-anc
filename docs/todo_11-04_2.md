# 修正計画: 設定UI保存処理の改善 & 補助ツール機能削除

**作成日**: 2025-11-04
**対象バージョン**: v3.2.1 → v3.3.0
**優先度**: 高

---

## 問題の概要

### 1. 設定UI保存処理の問題
- 保存ボタンを押すと**古い形式の.envファイル**が生成される
- v3.2.0で追加された`CHAT_API_BASE_URL`等の重要な設定が失われる
- 15項目以上の設定値とコメントが削除される

### 2. 不要な機能の存在
- 補助ツールの「ファイル」タブ: 完全に不要
- 補助ツールの「エディタ」タブ: 完全に不要

---

## 修正計画

## Part 1: 設定UI保存処理の改善

### 問題の原因

**ファイル**: [app/sidebar_tabs.py:1818-1897](../app/sidebar_tabs.py#L1818-L1897)

`_update_env_file()`メソッドが**ハードコードされた古いテンプレート**を使用:

```python
# 現在の実装（問題あり）
with open(env_file, 'w', encoding='utf-8') as f:
    f.write("# Project A.N.C. Environment Variables\n")
    f.write("# Updated via Settings UI\n\n")
    f.write("# API Provider (google or openai)\n")
    f.write(f"CHAT_API_PROVIDER={env_vars.get('CHAT_API_PROVIDER', 'google')}\n\n")
    # ... 11個の設定項目のみをハードコード
    # 他の15個以上の設定項目が失われる！
```

### 失われる設定項目（15項目以上）

```
CHAT_API_BASE_URL            ← v3.2.0で追加された重要な設定
GEMINI_MODEL
OPENAI_MODEL_NAME
ALICE_TEMPERATURE
OLLAMA_MODEL
SENTIMENT_COMPASS_MODEL
MAX_HISTORY_LENGTH
AUTO_SAVE_INTERVAL
DATA_DIR_NAME
NOTES_DIR_NAME
ARCHIVE_DIR_NAME
DB_FILE_NAME
MEMORIES_DIR_NAME
NIPPO_DIR_NAME
PROMPTS_DIR_NAME
CHAT_LOGS_DIR_NAME
ALICE_SYSTEM_PROMPT_FILE
ALICE_MEMORY_FILE
CREATE_MEMORY_PROMPT_FILE
CREATE_NIPPO_PROMPT_FILE
ANC_DEBUG
```

### 修正方針

**アプローチ: 既存ファイルの賢い更新処理**

1. **既存の.envファイルの全内容を保持**
   - コメント行をそのまま保持
   - セクション区切り（====）を保持
   - 未設定の項目も保持

2. **UIで変更された値のみをピンポイントで更新**
   - 正規表現で`KEY=value`形式を検出
   - 該当行のみを置換
   - 存在しないキーは末尾に追記

3. **バックアップ機能の追加**
   - 保存前に`.env.backup`を作成
   - 失敗時のロールバック処理

### 実装内容

#### 修正ファイル: [app/sidebar_tabs.py](../app/sidebar_tabs.py)

**メソッド**: `_update_env_file()` (行1818-1897)

**新しい実装ロジック**:

```python
def _update_env_file(self, env_vars: dict):
    """
    .envファイルを更新（既存の構造とコメントを保持）
    """
    env_file = Path('.env')
    backup_file = Path('.env.backup')

    try:
        # 1. バックアップ作成
        if env_file.exists():
            shutil.copy2(env_file, backup_file)

        # 2. 既存ファイルを読み込み
        existing_lines = []
        if env_file.exists():
            with open(env_file, 'r', encoding='utf-8') as f:
                existing_lines = f.readlines()

        # 3. UIで変更された設定項目のみを置換
        updated_keys = set()
        new_lines = []

        for line in existing_lines:
            # コメント行や空行はそのまま保持
            if line.strip().startswith('#') or not line.strip():
                new_lines.append(line)
                continue

            # KEY=value形式を検出
            match = re.match(r'^([A-Z_]+)=(.*)$', line.strip())
            if match:
                key = match.group(1)
                # UIで変更された値があれば置換
                if key in env_vars:
                    new_lines.append(f"{key}={env_vars[key]}\n")
                    updated_keys.add(key)
                else:
                    # 変更されていない値はそのまま保持
                    new_lines.append(line)
            else:
                new_lines.append(line)

        # 4. 新規追加された設定項目を末尾に追記
        new_keys = set(env_vars.keys()) - updated_keys
        if new_keys:
            new_lines.append("\n# Added via Settings UI\n")
            for key in sorted(new_keys):
                new_lines.append(f"{key}={env_vars[key]}\n")

        # 5. ファイルに書き込み
        with open(env_file, 'w', encoding='utf-8') as f:
            f.writelines(new_lines)

        return True

    except Exception as e:
        # ロールバック
        if backup_file.exists():
            shutil.copy2(backup_file, env_file)
        raise e
```

**修正範囲**: 約80行のコード書き換え

### 期待される効果

✅ 保存後も全ての設定項目が保持される
✅ コメントと構造が維持される
✅ v3.2.0以降の新設定も失われない
✅ バックアップによる安全性向上
✅ 将来追加される設定項目にも対応

---

## Part 2: 補助ツール機能の削除

### 削除対象

1. **「ファイル」タブ**: プロジェクトファイルのブラウジング機能
2. **「エディタ」タブ**: ファイル編集機能

### 削除理由

- 完全に不要な機能
- 使用されていない
- コードの保守負担

### 削除するコード

#### A. [app/sidebar_tabs.py](../app/sidebar_tabs.py)

**削除箇所**:
1. `FileTab`クラス全体 (行662-956) - 約294行
2. `EditorArea`クラス全体 (行958-1163) - 約205行

**合計削除**: 約499行

#### B. [app/ui_redesign.py](../app/ui_redesign.py)

**1. インポート文の修正** (行13):
```python
# 修正前
from sidebar_tabs import FileTab, EditorArea, AutomationAnalysisTab, SettingsTab, MemoryCreationTab, NippoCreationTab

# 修正後
from sidebar_tabs import AutomationAnalysisTab, SettingsTab, MemoryCreationTab, NippoCreationTab
```

**2. AuxiliaryToolsSidebarクラス内の削除**:

- **コンストラクタパラメータ削除** (行699):
  ```python
  on_file_operations=None,  # 削除
  on_save_file=None,        # 削除
  ```

- **インスタンス作成削除** (行709-718):
  ```python
  self.file_tab = FileTab(...)      # 削除
  self.editor_area = EditorArea(...) # 削除
  ```

- **タブリスト修正** (行743-753):
  ```python
  # 削除
  ft.Tab(text="ファイル", icon=ft.Icons.FOLDER, content=self.file_tab),
  ft.Tab(text="エディタ", icon=ft.Icons.EDIT, content=self.editor_area),
  ```

- **メソッド削除**:
  - `_on_file_select()` (行799-811)
  - `load_files()` (行813-815)

**3. ConversationFirstUIControllerクラス内の削除**:

- `auto_save_all_tabs()` メソッド (行1087-1093)
- Ctrl+S キーボードショートカット処理 (行1097-1106)

#### C. [app/main.py](../app/main.py)

**削除箇所** (行134):
```python
on_save_file=handlers.handle_save_file,  # 削除
```

#### D. [app/handlers.py](../app/handlers.py) (オプション)

**削除可能** (他で使用されていない場合):
- `handle_save_file()` メソッド (行84-152)

### 削除後のタブ構成

**修正前**: ファイル | エディタ | 分析 | 記憶 | 日報 | 設定 (6タブ)
**修正後**: 分析 | 記憶 | 日報 | 設定 (4タブ)

### 影響範囲

**影響なし**:
- 「記憶」タブ: 独立して動作
- 「日報」タブ: 独立して動作
- 「分析」タブ: 独立して動作
- 「設定」タブ: 独立して動作
- メイン会話エリア: 影響なし

**削除される機能**:
- プロジェクトファイルのブラウジング
- ファイルのエディタ編集
- ファイルの新規作成・削除・リネーム
- タグ編集UI
- ファイル保存機能
- Ctrl+S ショートカット
- 自動保存機能

---

## 実装手順

### ステップ1: 設定UI保存処理の修正

1. [app/sidebar_tabs.py](../app/sidebar_tabs.py) を開く
2. `_update_env_file()` メソッド (行1818-1897) を新しい実装に書き換え
3. 必要なインポート追加:
   ```python
   import re
   import shutil
   ```

### ステップ2: 補助ツール機能の削除

**2-1. sidebar_tabs.py**
1. FileTabクラス削除 (行662-956)
2. EditorAreaクラス削除 (行958-1163)

**2-2. ui_redesign.py**
1. インポート文修正 (行13)
2. AuxiliaryToolsSidebarクラス内の削除:
   - コンストラクタパラメータ
   - インスタンス作成
   - タブリスト
   - 関連メソッド
3. ConversationFirstUIControllerクラス内の削除:
   - auto_save_all_tabs()
   - Ctrl+Sショートカット

**2-3. main.py**
1. on_save_fileパラメータ削除 (行134)

**2-4. handlers.py (オプション)**
1. handle_save_file()メソッド削除 (行84-152)

### ステップ3: テスト

1. アプリケーション起動確認
2. 設定タブで各種設定を変更して保存
3. .envファイルの内容確認:
   - 全ての設定項目が保持されているか
   - コメントが保持されているか
   - 変更した値が正しく反映されているか
4. 補助ツールの4タブ（分析、記憶、日報、設定）の動作確認
5. エラーログ確認

---

## チェックリスト

### 修正前の確認
- [ ] 現在の.envファイルをバックアップ
- [ ] 設定UIの現在の動作を確認
- [ ] 補助ツールの使用状況を確認

### 実装中の確認
- [ ] 設定UI保存処理の修正完了
- [ ] sidebar_tabs.pyの削除完了
- [ ] ui_redesign.pyの削除完了
- [ ] main.pyの修正完了
- [ ] handlers.pyの修正完了（オプション）

### 修正後の確認
- [ ] アプリケーションが正常に起動する
- [ ] 設定保存が正常に動作する
- [ ] .envファイルの全項目が保持される
- [ ] 補助ツールが4タブになっている
- [ ] 各タブが正常に動作する
- [ ] エラーログにエラーがない

### ドキュメント更新
- [ ] CHANGELOG.md更新
- [ ] CLAUDE.md更新（補助ツールの説明削除）
- [ ] バージョン番号更新 (v3.2.0 → v3.2.1)

---

## 注意事項

### 1. データ損失のリスク
- 現在エディタで編集中の内容は失われる可能性がある
- ユーザーに事前警告が必要

### 2. バージョン管理
- マイナーバージョンアップとして扱う（v3.2.0 → v3.2.1）
- 機能削除なのでCHANGELOGに明記

### 3. ロールバック計画
- .envのバックアップ機能を実装
- Git履歴で簡単に戻せるようにコミットを分割

---

## 期待される成果

### 設定UI改善
✅ 保存時に設定項目が失われない
✅ コメントと構造が維持される
✅ 安全性向上（バックアップ機能）
✅ 将来の拡張性向上

### コード整理
✅ 約500行のコード削除
✅ 保守負担の軽減
✅ UIがシンプルになる
✅ 不要な機能の削除

### 総合効果
- コードの品質向上
- 保守性の向上
- ユーザー体験の改善（設定が失われない）

---

**作成者**: Claude
**承認待ち**: ユーザー確認後に実装開始
