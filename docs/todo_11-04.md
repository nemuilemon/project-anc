# TODO 2025-11-04: Compass API画像機能統合

## 概要
[alice_chat_manager.py](app/alice_chat_manager.py)に既存のCompass API画像渡し機能を有効化します。コードは既に実装済みですが、意図的に無効化されています（IMAGE COMMIT OFF BLOCK）。

## 変更内容

### 1. 画像エンコーディング機能の有効化
**ファイル:** [alice_chat_manager.py:119-131](app/alice_chat_manager.py#L119-L131)

**現在:** 画像パスを検出しても無視
**変更後:**
- Base64エンコーディングを実行
- MIMEタイプの自動検出（mimetypesモジュール使用）
- ChatImagePart形式でAPIメッセージに追加
- エラーハンドリング（ファイル未検出、読み込み失敗など）

### 2. ログ機能の拡張
**ファイル:** [alice_chat_manager.py:46-74](app/alice_chat_manager.py#L46-L74)

**変更:**
- `_log_api_dialog()`に画像情報のログ追加
- リクエストログに画像数とMIMEタイプを記録

### 3. 警告コメントの削除
**ファイル:** [alice_chat_manager.py:214-218](app/alice_chat_manager.py#L214-L218)

**変更:** IMAGE COMMIT OFF BLOCKの警告コメント削除（機能有効化後は不要）

## 技術詳細

### APIメッセージ形式（Compass API仕様準拠）
```python
{
    "role": "user",
    "content": "テキストメッセージ",
    "images": [  # オプショナル
        {
            "mime_type": "image/jpeg",
            "data": "Base64エンコードデータ"
        }
    ]
}
```

### 既存インフラの活用
- **State Manager:** 画像パスは既にmetadataに保存済み
- **UI Layer:** 画像パスは既に正しく渡されている
- **API Client:** リクエスト構造は変更不要

## 影響範囲
- **変更必要:** `alice_chat_manager.py`のみ
- **変更不要:** UI層、State Manager、その他のファイル
- **後方互換性:** あり（imagesフィールドはオプショナル）

## リスク
- **低:** 既存コードの有効化のため、新規実装ではない
- **懸念点:** 大きい画像ファイルの処理（Compass APIサーバー側で自動リサイズ）

## 実装の詳細分析

### Compass API仕様（v1.3.0）
ドキュメント: [compass_api.md](compass_api.md)

**画像サポート機能:**
- **ChatImagePart Model** (lines 225-231):
  - Base64エンコード画像データを受け付け
  - 標準MIMEタイプをサポート（image/jpeg, image/pngなど）
  - 構造: `{mime_type: string, data: string}`

- **ChatMessage拡張** (lines 234-241):
  - メッセージにオプショナルな`images: ChatImagePart[]`配列を追加可能
  - テキストコンテンツと同じメッセージ内で画像を送信
  - 後方互換性あり（imagesフィールドはオプショナル）

- **サーバー側最適化:**
  - API コスト削減のための自動画像リサイズ
  - 正確な画像トークン計算（768pxタイルベース）

**リクエスト例** (lines 675-693):
```json
{
  "messages": [
    {
      "role": "user",
      "content": "この画像には何が描かれていますか？",
      "images": [
        {
          "mime_type": "image/jpeg",
          "data": "/9j/4AAQSkZJRgABAQEA..."
        }
      ]
    }
  ],
  "config": {
    "model": "gemini-2.5-flash"
  }
}
```

### 現在の実装状況

**alice_chat_manager.py の構造:**

**a) メッセージ変換** (lines 109-138):
```python
def _convert_to_chat_messages(self) -> List[Dict[str, Any]]:
```
- 会話履歴をAppStateからChatMessage形式に変換
- **重要: Lines 119-131にIMAGE COMMIT OFF BLOCKが存在**
  - `msg['metadata']['image_path']`を検出するが明示的に無視
  - 将来の実装のためのbase64エンコーディングロジックがコメントアウト
  - 現在はテキストコンテンツのみ送信

**b) 設定構築** (lines 140-168):
```python
def _build_chat_config(self) -> Dict[str, Any]:
```
- ANC設定をCompass API ChatGeminiConfig形式にマッピング
- メモリ検索設定を処理
- モデル名とオプショナルなmemory_search_configで設定を適切に構造化

**c) API通信** (lines 170-202):
```python
def _call_chat_api(self, messages, config) -> Dict[str, Any]:
```
- `{base_url}/chat/gemini`にPOSTリクエスト
- ヘッダー経由でBearerトークン認証を追加
- 正しい形式でメッセージと設定を送信

**d) メイン送信フロー** (lines 204-268):
```python
def send_message(self, user_message: str, image_path: Optional[str] = None) -> str:
```
- **Lines 214-218**: image_pathパラメータは存在するが無視される（IMAGE COMMIT OFF BLOCK）
- フロー:
  1. metadataにimage_pathを含むユーザーメッセージをAppStateに追加
  2. チャットメッセージに変換（画像なし）
  3. 設定を構築
  4. APIを呼び出し
  5. モデルのレスポンスをAppStateに追加
  6. チャットログとダイアログログに記録

**主な問題:** image_pathはAppState metadataに保存される（line 228）が、API変換時に削除される（lines 119-131）。

### 必要な具体的変更

**フェーズ1: _convert_to_chat_messages()で画像エンコーディングを有効化**

Lines 119-131を有効化。image_pathを無視する代わりに:
```python
if msg.get('metadata') and msg['metadata'].get('image_path'):
    image_path = msg['metadata']['image_path']
    # 画像を読み込んでエンコード
    import base64
    with open(image_path, 'rb') as f:
        image_data = base64.b64encode(f.read()).decode('utf-8')

    # MIMEタイプを判定
    import mimetypes
    mime_type, _ = mimetypes.guess_type(image_path)
    if mime_type is None:
        mime_type = "image/jpeg"  # デフォルトフォールバック

    # 画像付きChatMessageを構築
    messages.append({
        "role": msg['role'],
        "content": msg['content'],
        "images": [
            {
                "mime_type": mime_type,
                "data": image_data
            }
        ]
    })
else:
    # 画像なし、テキストのみ送信
    messages.append({
        "role": msg['role'],
        "content": msg['content']
    })
```

**フェーズ2: メッセージ構築ロジックの更新**
- 画像のないメッセージのケースを処理（"images"フィールドなしで送信）
- 存在しない/読み込めない画像ファイルの適切なエラーハンドリング
- 画像が実際にAPIリクエストに含まれる際のログ記録

**フェーズ3: バリデーション追加**
- ファイルが存在し、読み込み可能かチェック
- MIMEタイプの検証
- サイズ制限を考慮（Compass APIに制約がある可能性）

**フェーズ4: ログの更新**
- `_log_api_dialog()` (lines 46-74)に画像情報のログを追加
- 現在は"message_count"をログするが、画像数もログすべき
- 画像が含まれていることを示すリクエストログの更新

### 関連するコードパターン

**a) State Managerパターン** (state_manager.py):
- メッセージはオプショナルなmetadataと共に保存: `metadata: Optional[Dict] = None`
- 現在の構造 (lines 303-308):
```python
message = {
    'role': role,
    'content': content,
    'timestamp': datetime.now().isoformat(),
    'metadata': metadata or {}
}
```
- 既にmetadataにimage_pathの保存をサポート！

**b) 画像パスの使用:**
- 現在UIレイヤー経由で渡される (ui_redesign.py):
  ```python
  self.on_send_message(message, image_path)
  response = self.alice_chat_manager.send_message(message, image_path=image_path)
  ```
- ハンドラー (handlers.py)もimage_pathパラメータを受け取る

**c) エラーハンドリングパターン:**
- 特定のエラータイプでtry-exceptブロックを使用
- 日本語でユーザーフレンドリーなエラーメッセージを返す
- 詳細なエラーをコンソールにログ

**d) APIリクエスト構造:**
- 既にAPI消費のために正しく構造化
- ChatMessageオブジェクトにimagesフィールドを追加するだけ
- `_call_chat_api()`や`_build_chat_config()`への変更は不要

## 変更の要約

| ファイル | 行 | 変更内容 | 影響 |
|---------|-----|----------|------|
| `alice_chat_manager.py` | 119-131 | 画像エンコーディングロジックのコメント解除と有効化 | Base64エンコーディングを有効化 |
| `alice_chat_manager.py` | 119-136 | MIMEタイプ検出の追加 | 様々な画像形式をサポート |
| `alice_chat_manager.py` | 119-136 | ChatImagePartオブジェクトの構築 | 正しいAPIメッセージ形式を作成 |
| `alice_chat_manager.py` | 46-74 | `_log_api_dialog()`の更新 | デバッグログに画像情報を記録 |
| `alice_chat_manager.py` | 214-218 | IMAGE COMMIT OFF BLOCK警告の削除 | 画像サポート有効化の通知を再有効化 |

**変更不要:**
- `state_manager.py` - 既にmetadataにimage_pathを保存
- `_call_chat_api()` - 既に正しい形式で送信
- `_build_chat_config()` - 設定は既に正しい
- UIレイヤー (`ui_redesign.py`, `main.py`) - 既に正しくimage_pathを渡している

## 結論
これは大規模なアーキテクチャ変更ではなく、既に準備されているが意図的に無効化されている機能の有効化です。
