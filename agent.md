## **プロジェクト『Project A.N.C.』技術仕様書**

### **1. プロジェクト概要**

本プロジェクトは、ユーザーの思考と知識を統合し、AIと共に成長させることを目的とした**パーソナル・ナレッジ・エンジン**である。単なるメモアプリではなく、ユーザー専用の「第二の脳」として機能し、知的生産活動を支援するデスクトップアプリケーションの開発を目指す。

### **2. コアアーキテクチャ**

本アプリケーションは、UI、データ管理、AIシステムの3層からなる疎結合なアーキテクチャを採用している。

* **UI (ユーザーインターフェース)**
    * Pythonのフレームワーク**Flet**を利用し、デスクトップアプリケーションのUIを構築している。これにより、Pythonコードのみで迅速な開発とクロスプラットフォーム展開の可能性を確保する。

* **データ管理 (ハイブリッドモデル)**
    * メモの**本文**は、プレーンテキストの**Markdownファイル (.md)** としてファイルシステムに直接保存される。
    * 各メモの**メタデータ**（タイトル、ファイルパス、タグ等）は、軽量なNoSQLデータベースである**TinyDB**にJSON形式で保存される。
    * このハイブリッド方式により、データの可搬性と高速なメタデータ検索を両立させている。

#### **データベーススキーマ**
TinyDBに保存される各ファイルレコードの構造：
```json
{
    "title": "ファイル名.md",
    "path": "C:\\notes\\ファイル名.md",
    "tags": ["タグ1", "タグ2", "タグ3"],
    "status": "active",
    "order_index": 1
}
```

**フィールド説明:**
- `title`: ファイル名（表示用）
- `path`: ファイルの絶対パス
- `tags`: AIまたは手動で付与されたタグの配列
- `status`: ファイル状態（`"active"` または `"archived"`）
- `order_index`: ファイル表示順序（数値、小さい順に表示）

**レガシーサポート:**
既存ファイルで`status`や`order_index`が未設定の場合、それぞれ`"active"`と`0`として扱われる。

* **AIシステム (ハイブリッド・ブレイン)**
    * ローカル環境で動作するLLM実行環境**Ollama**を「小脳」として利用する。
    * メモの内容をOllamaに送信し、キーワードを抽出させることで、**AIによる自動タギング**機能を実現している。

### **3. 技術スタック**

* **プログラミング言語**: **Python**
* **UIフレームワーク**: **Flet**
* **データベース**: **TinyDB**
* **AI連携**: **Ollama** (`ollama` Pythonライブラリ経由)

### **4. システム構成とコンポーネント**

本プロジェクトは、責務分離の原則に基づき、以下の4つの主要モジュールで構成されている。

* `main.py`
    * アプリケーションの**エントリーポイント（起動ファイル）**。
    * Fletアプリケーションの初期化、ウィンドウの生成、および各モジュールの連携を行う。UIからのイベント（ボタンクリック等）を受け取り、対応するロジックを呼び出す**司令塔**の役割を担う。

* `ui.py`
    * **UIコンポーネント**の定義とレイアウトを管理する。
    * Fletのウィジェット（AppBar, Tabs, ListTile, AlertDialog等）を用いて、ユーザーが直接操作する画面のすべてを構築する。ユーザーのアクションを`main.py`のハンドラ関数に伝達する。

* `logic.py`
    * アプリケーションの**ビジネスロジック**をすべて担当する。
    * ファイルの読み書き、TinyDBへのデータ登録・更新、Ollama APIとの通信といった、UIに依存しないコアな処理をすべて集約している。

* `config.py`
    * アプリケーションの**設定情報**を管理する。
    * メモを保存するディレクトリパス、データベースファイル名、使用するOllamaのモデル名など、変更される可能性のある値を一元管理し、保守性を高めている。

### **5. 開発環境セットアップ**

#### **仮想環境**
* プロジェクトは**Python仮想環境（.venv）**を使用して依存関係を管理している。
* 仮想環境の作成と有効化:
  ```bash
  python -m venv .venv
  # Windows
  .venv\Scripts\activate
  # macOS/Linux
  source .venv/bin/activate
  ```

#### **依存関係**
* **Flet**: UIフレームワーク
* **TinyDB**: 軽量JSONデータベース
* **Ollama**: AI連携用Pythonライブラリ

#### **実行方法**
```bash
# 仮想環境を有効化後
python main.py
```

### **6. 主要機能一覧**

* **タブベースのテキストエディタ機能**: 複数のメモを同時に開いて編集できる。
* **新規ファイル作成機能**: AppBarの「+」ボタンから新しい空の.mdファイルを作成し、自動的にタブで開く。
* **ファイルリスト表示**: 指定されたディレクトリ内のMarkdownファイルを一覧表示する。
* **ファイルの順番入れ替え機能**: ドラッグ＆ドロップでファイルの表示順序を自由に変更できる。順序はデータベースに永続化される。
* **アーカイブ機能**: ファイルを`.archive`フォルダに移動してアーカイブ化。表示切替スイッチで表示/非表示を制御できる。
* **ハイブリッド保存**: ファイル保存時に、本文は`.md`ファイルへ、メタデータは`anc_db.json`へ自動的に書き込む。
* **AIによる自動タグ分析**: 「Analyze Tags」ボタン押下時に、アクティブなメモの内容をOllamaに送信し、関連タグを自動で付与・更新する。
* **ファイルリストの手動更新**: 「更新」ボタンにより、ディレクトリ内の新しいファイルを検知し、データベースに同期する。
* **タグの手動編集**: 各ファイルの横にある編集アイコンから、タグを自由に追加・修正・削除できる。
* **ファイル名変更機能**: ポップアップメニューからファイル名を変更できる。
* **タブ閉じる機能**: 各タブの×ボタンでファイルを閉じる際に自動保存される。